# セキュリティガイドライン

このファイルは、Claude Codeがコードを作成・編集する際に遵守すべきセキュリティ要件を定義します。

## 入力値検証

### Controller層での検証

#### 必須実装事項
- **JSONバリデーション**: `ValidationMiddleware.ValidateJSON` を使用
- **Content-Type検証**: `ContentTypeValidation` ミドルウェアを適用
- **リクエストサイズ制限**: `RequestSizeLimit` で大容量攻撃を防止
- **構造化バリデーション**: `validate` タグによる自動検証

### SQLインジェクション対策

#### GORM使用時の注意事項
- **パラメータ化クエリ**: GORM標準メソッド使用（Where, Find等）
- **Raw SQLの制限**: やむを得ない場合のみ、プレースホルダー使用必須
- **動的クエリ検証**: ユーザー入力による直接的なSQL構築禁止

### XSS・CSRF対策

#### Web API向け対策
- **Content-Type厳格化**: `application/json` のみ許可
- **HTMLエスケープ**: レスポンス内の文字列は適切にエスケープ
- **CSRFトークン**: 状態変更APIでのトークン検証（将来実装）

## データベースセキュリティ

### 接続情報管理

#### 必須設定
- **本番環境**: `sslmode=require` 設定必須
- **接続制限**: 最小限の接続プール設定

### PostgreSQLコンテナセキュリティ

#### 本番環境での考慮事項
- **暗号化**: データベースレベルでの暗号化
- **アクセス制御**: IPホワイトリスト設定

### データ保護

#### センシティブデータ暗号化
- **個人情報**: 必要に応じてアプリケーションレベル暗号化
- **パスワード**: bcryptによるハッシュ化（将来実装）
- **トークン**: JWT署名検証

## ログ・監査

### 構造化ログ実装

#### 現在のロガーミドルウェア活用

#### セキュリティログ追加要件
- **認証イベント**: ログイン成功/失敗
- **権限チェック**: アクセス拒否イベント
- **異常なアクセス**: レート制限違反、不正リクエスト
- **データ変更**: 重要なデータの作成/更新/削除

### センシティブ情報のマスキング

#### 禁止事項
- **パスワード・トークンの平文ログ出力**
- **個人情報の詳細ログ**（IDのみ記録）
- **データベース接続文字列の全体出力**

### 監査証跡

#### RequestID による追跡
- **全リクエスト**: `generateRequestID` による一意ID付与
- **関連処理**: 同一RequestIDでの処理追跡
- **エラー追跡**: エラー発生時の詳細コンテキスト保存

#### ログ保存・分析
- **ログローテーション**: 日次ローテーション推奨
- **長期保存**: セキュリティログの最低90日保存
- **監視アラート**: 異常パターンの自動検知（将来実装）

## セキュリティチェックリスト

### 開発時必須チェック項目

#### コードレビュー時
- [ ] センシティブ情報のハードコード無し
- [ ] 適切な入力値検証実装
- [ ] SQLインジェクション対策確認
- [ ] エラーハンドリングでの情報漏洩防止
- [ ] ログ出力でのセンシティブデータマスキング

#### デプロイ前チェック
- [ ] 環境変数による設定分離
- [ ] 本番用データベース接続設定
- [ ] HTTPS通信の強制
- [ ] セキュリティヘッダーの設定
- [ ] 脆弱性スキャン実行

#### 運用時監視
- [ ] ログ監視・アラート設定
- [ ] 異常アクセスパターンの検知
- [ ] 定期的なセキュリティパッチ適用
